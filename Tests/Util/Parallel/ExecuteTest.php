<?php
/**
 * Test class for Mergy_Util_Parallel.
 * Generated by PHPUnit on 2011-10-23 at 17:48:39.
 */
class Mergy_Util_Parallel_ExecuteTest extends PHPUnit_Framework_TestCase {

    /**
     * The object to test with
     *
     * @var string
     */
    const TEST_MOCK = 'Mergy_Util_Parallel_Transport_File';

    /**
     * @var Mergy_Util_Parallel_Execute
     */
    protected $_object;

    /**
     * Sets up the fixture, for example, opens a network connection.
     * This method is called before a test is executed.
     */
    protected function setUp() {
        $aStack = array();
        for ($i = 0; $i < 4; $i++) {
            $oMock = $this->getMock(self::TEST_MOCK);
            $oMock->expects($this->any())->method('free')->will($this->returnSelf());
            $aStack[] = $oMock;
        }

        $oTransport = $this->getMock(self::TEST_MOCK);
        $oTransport->expects($this->at(0))->method('read')->will($this->returnValue(false));
        $oTransport->expects($this->any())->method('read')->will($this->returnValue(gzcompress(serialize($oTransport))));
        $oTransport->expects($this->any())->method('write')->will($this->returnSelf());
        $oTransport->expects($this->any())->method('free')->will($this->returnSelf());

        $this->_object = new Mergy_Util_Parallel_Execute($aStack, $oTransport);
    }

    /**
     * Tears down the fixture, for example, closes a network connection.
     * This method is called after a test is executed.
     */
    protected function tearDown() {
    }

    /**
     * Test the complete workflow
     */
    public function testWorkflow() {
        $this->assertInstanceOf('Mergy_Util_Parallel_Execute', $this->_object->threads());
        $this->assertEquals(Mergy_Util_Parallel_Execute::THREADS, $this->_object->getThreads());
        $this->assertInstanceOf('Mergy_Util_Parallel_Execute', $this->_object->threads(2));
        $this->assertEquals(2, $this->_object->getThreads());

        $this->assertInstanceOf('Mergy_Util_Parallel_Execute', $this->_object->run(array(
            'free'
        )));

        $aStack = $this->_object->get();
        $this->assertInternalType('array', $aStack);
        $this->assertEquals(4, count($aStack));
        foreach ($aStack as $oItem) {
            $this->assertInstanceOf(self::TEST_MOCK, $oItem);
        }
    }
}
